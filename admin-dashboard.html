<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Personality Quiz Builder</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
    }
    th {
      background-color: #f2f2f2;
    }
    input[type="text"], select {
      width: 100%;
    }
    img {
      max-height: 30px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <button onclick="addNewQuestion()">Add Question</button>
  <button onclick="saveAllQuestions()">Save Questions</button>
  <br><br>

  <div id="question-container"></div>

  <script>
    const STORAGE_KEY = "personalityQuizQuestions";

    function sanitizeFilename(filename) {
      return filename
        .toLowerCase()
        .replace(/\s+/g, '-')              // spaces to dashes
        .replace(/[^a-z0-9\-\.]/g, '')     // remove unsafe characters
        .replace(/\-+/g, '-');             // remove multiple dashes
    }

    function handleImageUpload(input, previewImg, hiddenInput) {
      const file = input.files[0];
      if (!file) return;

      const sanitized = sanitizeFilename(file.name);
      const uploadPath = `assets/uploads/${sanitized}`;

      const reader = new FileReader();
      reader.onload = () => {
        previewImg.src = reader.result;
        previewImg.style.display = 'inline';
        hiddenInput.value = uploadPath;
      };
      reader.readAsDataURL(file);
    }

    function addNewQuestion(existing = null) {
      const container = document.getElementById("question-container");
      const table = document.createElement("table");

      const questionId = `Q${Date.now()}`;
      const topic = existing?.topic || "";
      const prompt = existing?.prompt || "";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th colspan="7">
            Topic: <input type="text" value="${topic}" class="topic-input">
            Prompt: <input type="text" value="${prompt}" class="prompt-input">
          </th>
        </tr>
        <tr>
          <th>Answer (A)</th>
          <th>Color (F)</th>
          <th>Status (G)</th>
          <th>Description (D)</th>
          <th>Image</th>
          <th>Preview</th>
          <th>Image URL</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const options = existing?.options || [{}, {}, {}, {}];
      for (let i = 0; i < 4; i++) {
        const row = document.createElement("tr");

        const opt = options[i] || {};
        const colorOptions = ['Blue', 'Orange', 'Green', 'Gold'];
        const statusOptions = ['Ask', 'Ignore'];

        row.innerHTML = `
          <td><input type="text" value="${opt.answer || ''}" class="answer-input"></td>
          <td>
            <select class="color-select">
              ${colorOptions.map(c => `<option${opt.color === c ? ' selected' : ''}>${c}</option>`).join('')}
            </select>
          </td>
          <td>
            <select class="status-select">
              ${statusOptions.map(s => `<option${(opt.status || 'Ask') === s ? ' selected' : ''}>${s}</option>`).join('')}
            </select>
          </td>
          <td><textarea class="description-input">${opt.description || ''}</textarea></td>
          <td>
            <input type="file" accept="image/*"
              onchange="handleImageUpload(this, this.nextElementSibling, this.nextElementSibling.nextElementSibling)">
          </td>
          <td><img src="${opt.imageUrl || ''}" ${opt.imageUrl ? 'style="display:inline;"' : 'style="display:none;"'}></td>
          <td><input type="hidden" class="image-url-input" value="${opt.imageUrl || ''}"></td>
        `;
        tbody.appendChild(row);
      }

      table.appendChild(tbody);
      container.appendChild(table);
      container.appendChild(document.createElement("br"));
    }

    function saveAllQuestions() {
      const tables = document.querySelectorAll("#question-container table");
      const questions = {};

      tables.forEach(table => {
        const topic = table.querySelector(".topic-input").value.trim();
        const prompt = table.querySelector(".prompt-input").value.trim();
        const key = `${topic}||${prompt}`;
        const rows = table.querySelectorAll("tbody tr");
        const options = [];

        rows.forEach(row => {
          options.push({
            answer: row.querySelector(".answer-input").value.trim(),
            color: row.querySelector(".color-select").value,
            status: row.querySelector(".status-select").value,
            description: row.querySelector(".description-input").value.trim(),
            imageUrl: row.querySelector(".image-url-input").value.trim()
          });
        });

        questions[key] = options;
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(questions));
      alert("Questions saved successfully!");
    }

    function loadQuestionsFromLocal() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) return;

      const grouped = JSON.parse(stored);
      for (const [key, options] of Object.entries(grouped)) {
        const [topic, prompt] = key.split("||");
        addNewQuestion({ topic, prompt, options });
      }
    }

    document.addEventListener("DOMContentLoaded", loadQuestionsFromLocal);
  </script>
</body>
</html>
